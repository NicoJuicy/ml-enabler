set -euo pipefail

if [[ -z ${ASSET_BUCKET} ]]; then
    echo "ASSET_BUCKET env must be set"
    exit 1
elif [[ -z ${PROJECT_ID} ]]; then
    echo "PROJECT_ID env must be set"
    exit 1
elif [[ -z ${ITERATION_ID} ]]; then
    echo "ITERATION_ID env must be set"
    exit 1
fi

mkdir ./data || true
rm -rf ./data/*
mkdir ./data/raw/

aws s3 cp --recursive s3://${ASSET_BUCKET}/project/${PROJECT_ID}/iteration/${ITERATION_ID}/prediction/ data/raw/
find ./data/raw/ -type f -exec gunzip {} +
cat $(find ./data/raw/ -type f) | base64 --decode > ./data/input.geojson
rm -rf ./data/raw

node index.js
